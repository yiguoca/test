# [Logstash](https://www.elastic.co/guide/en/logstash/7.x/index.html)

Logstash is being used to read logs from Kafka and ship them to Elastic.

By default Logstash will create consumer offsets for the configured Topics starting at the end/tail of the topic.  If you have a lot of data in a topic and this is the first time Logstash is reading from it, you will need to override that behaviour.

## SSL
Elastic Cloud on Kubernetes (ECK) provisions its own internal certs by default.  In order to connect Logstash to the ECK cluster you need to add the cert to the Logstash pod.

`hack.yaml` has a CA cert extracted from ECK.  There's not a pretty way to deal with this since you can't reference the ECK secrets from another namespace.

_Logging Update_: Logstash is planned to be deployed in the same namespace as the elastic instance. Similarly, in all cases logstash is deployed in the same namespace as elastic, access to the generated CA cert is available by secretRef.  
In cases logstash is deployed outside of the namespace see the `thycotic-ssl-certificate-update.sh` job and generated secretId in the `cluster/elastic/stage1` folder.


# Logstash pipelines

# Pipeline Access Logs

# Filters
## Photon Parameters

* Generic - Query String Parameter (%w+)=(%w+) - modelYearCode=IUT202213
* Language Code - Path Variable (%w%w) - /EN/
* CCode - Path Variable /ccode/([CI]U%w%w%w%w%w%w%w%w%w%w%w%w%w%w)/ - /CUJ202213DS1H98J/
* LLPCode - Path Variable /lowerLevelPackages/(%w%w%w)/ - /2TF/
* ModelYearCode - Path Variable /([CI]U%w%w%w%w%w%w%w

## Photon Path

* Path - ^\/hostd\/api\/(?<fca_api>[\w-]+)(?<fca_path>\/?[\w\/-]*)(\.?.*)$ - /hostd/api/catalog-option/EN/details/models/CUJ202118WLTH75A/lowerLevelPackages/2TA.json
* Parameters - ^\/(?<fca_api>hostd(?!\/api)[\/\w-]*)\/.*$


## Example Nginx Access Logs

```json Nginx Upstream Format
{"nginx":{"namespace":"$namespace","host":"$host","proxy_protocol_addr":"$proxy_protocol_addr","remote_addr":"$remote_addr","proxy_add_x_forwarded_for":"$proxy_add_x_forwarded_for","remote_user":"$remote_user","time_local":"$time_local","request_method":"$request_method","request":"$request","status":"$status","body_bytes_sent":"$body_bytes_sent","http_referer":"$http_referer","http_user_agent":"$http_user_agent","request_length":"$request_length","request_time":"$request_time","proxy_upstream_name":"$proxy_upstream_name","upstream_addr":"$upstream_addr","upstream_response_length":"$upstream_response_length","upstream_response_time":"$upstream_response_time","upstream_status":"$upstream_status","uri":"$uri","request_uri":"$request_uri","query_params":"$args","geoip":{"location":{"lat":"0","lon":"0"},"region_name":"","city_country_name":"","city":"","city_country_code":""}}}
```

```json hostd/inventory
{"nginx":{"namespace":"blue","host":"www.ramtrucks.com","proxy_protocol_addr":"","remote_addr":"23.201.194.27","proxy_add_x_forwarded_for":"129.110.242.94, 23.45.183.29, 23.201.194.27","remote_user":"","time_local":"31/May/2022:14:17:18 +0000","request_method":"GET","request":"GET /hostd/inventory/getinventoryresults.json?attributes=drive:4x2&includeIncentives=N&matchType=P&modelYearCode=IUT202213&optionCodes=ERB%2CDFT%2CPAU%2CRC3%2CASJ%2CAM8%2CAFC%2CADA%2CX9%2CP1&pageNumber=1&pageSize=10&radius=200&sortBy=0&variation=WARLOCK&zip=75252 HTTP/1.1","status":"200","body_bytes_sent":"56132","http_referer":"https://www.ramtrucks.com/new-inventory.ram_1500.2022.html?ccode=CUT202213DS1H98J&llp=2TF&modelYearCode=IUT202213&radius=200&variation=WARLOCK&optionCodes=ERB,DFT,PAU,RC3,ASJ,AM8,AFC,ADA,X9,P1&drive=4x2&ref=bmo&zip=75252","http_user_agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/102.0.5005.63 Safari/537.36","request_length":"4905","request_time":"0.217","proxy_upstream_name":"blue-ws-inventory-40-80","upstream_addr":"10.233.97.182:8080","upstream_response_length":"56084","upstream_response_time":"0.220","upstream_status":"200","uri":"/hostd/inventory/getinventoryresults.json","request_uri":"/hostd/inventory/getinventoryresults.json?attributes=drive:4x2&includeIncentives=N&matchType=P&modelYearCode=IUT202213&optionCodes=ERB%2CDFT%2CPAU%2CRC3%2CASJ%2CAM8%2CAFC%2CADA%2CX9%2CP1&pageNumber=1&pageSize=10&radius=200&sortBy=0&variation=WARLOCK&zip=75252","query_params":"attributes=drive:4x2&includeIncentives=N&matchType=P&modelYearCode=IUT202213&optionCodes=ERB%2CDFT%2CPAU%2CRC3%2CASJ%2CAM8%2CAFC%2CADA%2CX9%2CP1&pageNumber=1&pageSize=10&radius=200&sortBy=0&variation=WARLOCK&zip=75252","geoip":{"location":{"lat":"0","lon":"0"},"region_name":"","city_country_name":"","city":"","city_country_code":""}}}
```

```json hostd/api/configure
{"nginx":{"namespace":"blue","host":"www.jeep.com","proxy_protocol_addr":"","remote_addr":"184.30.43.18","proxy_add_x_forwarded_for":"2600:1700:1e20:c770:384a:f716:9d29:f71, 23.52.41.157, 184.30.43.18","remote_user":"","time_local":"31/May/2022:14:17:18 +0000","request_method":"GET","request":"GET /hostd/api/configure/EN/states/IL/models/CUJ202211JTJP98C/lowerLevelPackages/2TN/configurations/eJxd0ttygyAQBuAX4kKxkyaXyCmDyhChSntBfJA8fDHpNPs7jiPfLour8HjwD89a1jyvyDY9y02ZVOqTde_wHqo3DdUZRU2aFJefVlCKIBh_MypdB6-8ZSUlS7nOnnIY6_hfX-JGF86Xe9PSruubtmEsYf3cE83fQpIVfvJPdi8qs1Dq7CinYCmd62hH1wSUkVPGdKa0RiEF5eQHYB-A5pC9UeYI_0k5A5yBo-5hqSnBJywTZBdoUlw9ZiXWBuQKteoEbYRvoF-AMuHkDBRQm63DXYAmhWthsvBI-MCImxIt0Gmo7XHLsr5QJnE4d6F394ZDRPk9Qk5xiPpYlc-HquwkLRnNTPkL4p7V4A/options/XNY HTTP/1.1","status":"200","body_bytes_sent":"4059","http_referer":"https://www.jeep.com/bmo.gladiator.2022.html","http_user_agent":"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/15.5 Safari/605.1.15","request_length":"4428","request_time":"0.034","proxy_upstream_name":"blue-configure-business-40-80","upstream_addr":"10.233.91.206:8080","upstream_response_length":"4106","upstream_response_time":"0.032","upstream_status":"200","uri":"/configure/EN/states/IL/models/CUJ202211JTJP98C/lowerLevelPackages/2TN/configurations/eJxd0ttygyAQBuAX4kKxkyaXyCmDyhChSntBfJA8fDHpNPs7jiPfLour8HjwD89a1jyvyDY9y02ZVOqTde_wHqo3DdUZRU2aFJefVlCKIBh_MypdB6-8ZSUlS7nOnnIY6_hfX-JGF86Xe9PSruubtmEsYf3cE83fQpIVfvJPdi8qs1Dq7CinYCmd62hH1wSUkVPGdKa0RiEF5eQHYB-A5pC9UeYI_0k5A5yBo-5hqSnBJywTZBdoUlw9ZiXWBuQKteoEbYRvoF-AMuHkDBRQm63DXYAmhWthsvBI-MCImxIt0Gmo7XHLsr5QJnE4d6F394ZDRPk9Qk5xiPpYlc-HquwkLRnNTPkL4p7V4A/options/XNY","request_uri":"/hostd/api/configure/EN/states/IL/models/CUJ202211JTJP98C/lowerLevelPackages/2TN/configurations/eJxd0ttygyAQBuAX4kKxkyaXyCmDyhChSntBfJA8fDHpNPs7jiPfLour8HjwD89a1jyvyDY9y02ZVOqTde_wHqo3DdUZRU2aFJefVlCKIBh_MypdB6-8ZSUlS7nOnnIY6_hfX-JGF86Xe9PSruubtmEsYf3cE83fQpIVfvJPdi8qs1Dq7CinYCmd62hH1wSUkVPGdKa0RiEF5eQHYB-A5pC9UeYI_0k5A5yBo-5hqSnBJywTZBdoUlw9ZiXWBuQKteoEbYRvoF-AMuHkDBRQm63DXYAmhWthsvBI-MCImxIt0Gmo7XHLsr5QJnE4d6F394ZDRPk9Qk5xiPpYlc-HquwkLRnNTPkL4p7V4A/options/XNY","query_params":"","geoip":{"location":{"lat":"0","lon":"0"},"region_name":"","city_country_name":"","city":"","city_country_code":""}}}
```

```json hostd/api/configure
{"nginx":{"namespace":"blue","host":"www.dodge.com","proxy_protocol_addr":"","remote_addr":"23.38.171.87","proxy_add_x_forwarded_for":"174.204.135.135, 23.59.251.93, 23.38.171.87","remote_user":"","time_local":"31/May/2022:14:17:19 +0000","request_method":"GET","request":"GET /hostd/api/configure/EN/states/NY/models/CUD202204LDDT48E/lowerLevelPackages/2DD/configurations/eJx1lNuugyAQRX-IB1vtxUcE1JhiVGiLPlg_pB9_KPYym_bEmLD2yHTYM-V-3x4k27EkPIYtyjSLLNWSqmb2a7Z_h2YvU7SjCcuNfwWbr3UX4PEMHo8s_XzLO86yD575unW7bnX5LdnRXJ3gD2XzKatrrS1OSbb4TIsvGer0Ly2sEe0zVcIqNgvRUGynmqKrS4q6qgDHLeA0AV4wqjj8btU9MRjiJkujdmzJ-WY5hVW6np_rNnjztqsPtq5bFx-dX34Qk39aIyZJnb64yGm3_8_o63ERqvmZ1Jlbsod-cRV3kJ_jbwodK0LGu5SIlbKPlSH9Ui5xZvNVz6WLleshVtwxyqNVTZukVTTxClCWgGUOaKjNHgVGK-iKtYAmx-iJpnJWY_QMR9hJwM0BowUc0IAhreogeoSa9ThR9MNCZjbMjB8hGBv_N9_SaXwIaSxkIJjXlvQjZLGwo4Koelq0qOBIokKj96_8REhjIaPCYAtG749cUxyMxihcRXzc0NoGARfGIPFmGkZA02PXoa_O9hT_AHz2VZ0/options/SCE HTTP/1.1","status":"200","body_bytes_sent":"5086","http_referer":"https://www.dodge.com/bmo.charger.2022.html","http_user_agent":"Mozilla/5.0 (X11; CrOS x86_64 14526.89.0) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/100.0.4896.133 Safari/537.36","request_length":"4689","request_time":"0.036","proxy_upstream_name":"blue-configure-business-40-80","upstream_addr":"10.233.92.144:8080","upstream_response_length":"5152","upstream_response_time":"0.036","upstream_status":"200","uri":"/configure/EN/states/NY/models/CUD202204LDDT48E/lowerLevelPackages/2DD/configurations/eJx1lNuugyAQRX-IB1vtxUcE1JhiVGiLPlg_pB9_KPYym_bEmLD2yHTYM-V-3x4k27EkPIYtyjSLLNWSqmb2a7Z_h2YvU7SjCcuNfwWbr3UX4PEMHo8s_XzLO86yD575unW7bnX5LdnRXJ3gD2XzKatrrS1OSbb4TIsvGer0Ly2sEe0zVcIqNgvRUGynmqKrS4q6qgDHLeA0AV4wqjj8btU9MRjiJkujdmzJ-WY5hVW6np_rNnjztqsPtq5bFx-dX34Qk39aIyZJnb64yGm3_8_o63ERqvmZ1Jlbsod-cRV3kJ_jbwodK0LGu5SIlbKPlSH9Ui5xZvNVz6WLleshVtwxyqNVTZukVTTxClCWgGUOaKjNHgVGK-iKtYAmx-iJpnJWY_QMR9hJwM0BowUc0IAhreogeoSa9ThR9MNCZjbMjB8hGBv_N9_SaXwIaSxkIJjXlvQjZLGwo4Koelq0qOBIokKj96_8REhjIaPCYAtG749cUxyMxihcRXzc0NoGARfGIPFmGkZA02PXoa_O9hT_AHz2VZ0/options/SCE","request_uri":"/hostd/api/configure/EN/states/NY/models/CUD202204LDDT48E/lowerLevelPackages/2DD/configurations/eJx1lNuugyAQRX-IB1vtxUcE1JhiVGiLPlg_pB9_KPYym_bEmLD2yHTYM-V-3x4k27EkPIYtyjSLLNWSqmb2a7Z_h2YvU7SjCcuNfwWbr3UX4PEMHo8s_XzLO86yD575unW7bnX5LdnRXJ3gD2XzKatrrS1OSbb4TIsvGer0Ly2sEe0zVcIqNgvRUGynmqKrS4q6qgDHLeA0AV4wqjj8btU9MRjiJkujdmzJ-WY5hVW6np_rNnjztqsPtq5bFx-dX34Qk39aIyZJnb64yGm3_8_o63ERqvmZ1Jlbsod-cRV3kJ_jbwodK0LGu5SIlbKPlSH9Ui5xZvNVz6WLleshVtwxyqNVTZukVTTxClCWgGUOaKjNHgVGK-iKtYAmx-iJpnJWY_QMR9hJwM0BowUc0IAhreogeoSa9ThR9MNCZjbMjB8hGBv_N9_SaXwIaSxkIJjXlvQjZLGwo4Koelq0qOBIokKj96_8REhjIaPCYAtG749cUxyMxihcRXzc0NoGARfGIPFmGkZA02PXoa_O9hT_AHz2VZ0/options/SCE","query_params":"","geoip":{"location":{"lat":"0","lon":"0"},"region_name":"","city_country_name":"","city":"","city_country_code":""}}}
```

```json hostd/api/catalog-option
{"nginx":{"namespace":"blue","host":"www.jeep.com","proxy_protocol_addr":"","remote_addr":"184.30.43.16","proxy_add_x_forwarded_for":"96.61.52.72, 165.225.57.39, 23.56.168.198, 184.30.43.16","remote_user":"","time_local":"31/May/2022:14:17:16 +0000","request_method":"GET","request":"GET /hostd/api/catalog-option/EN/details/models/CUJ202118WLTH75A/lowerLevelPackages/2TA.json HTTP/1.1","status":"200","body_bytes_sent":"7547","http_referer":"https://www.jeep.com/all-new-grand-cherokee-3-row.html","http_user_agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/102.0.5005.63 Safari/537.36","request_length":"4075","request_time":"0.035","proxy_upstream_name":"blue-catalog-option-business-40-80","upstream_addr":"10.233.98.86:8080","upstream_response_length":"7541","upstream_response_time":"0.036","upstream_status":"200","uri":"/catalog-option/EN/details/models/CUJ202118WLTH75A/lowerLevelPackages/2TA.json","request_uri":"/hostd/api/catalog-option/EN/details/models/CUJ202118WLTH75A/lowerLevelPackages/2TA.json","query_params":"","geoip":{"location":{"lat":"0","lon":"0"},"region_name":"","city_country_name":"","city":"","city_country_code":""}}}
```

```json hostd/incentives/getfeaturedoffers.json
{"nginx":{"namespace":"blue","host":"www.ramtrucks.com","proxy_protocol_addr":"","remote_addr":"104.103.70.31","proxy_add_x_forwarded_for":"74.104.135.248, 184.25.148.140, 104.103.70.31","remote_user":"","time_local":"31/May/2022:14:17:19 +0000","request_method":"GET","request":"GET /hostd/incentives/getfeaturedoffers.json?ccode=&llp=&modelYearCode=CUT202215&trim=&zip=02738 HTTP/1.1","status":"200","body_bytes_sent":"7387","http_referer":"https://www.ramtrucks.com/bmo.ram_3500.2022.html","http_user_agent":"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/15.4 Safari/605.1.15","request_length":"3989","request_time":"0.121","proxy_upstream_name":"blue-ws-incentives-40-80","upstream_addr":"10.233.91.216:8080","upstream_response_length":"7381","upstream_response_time":"0.124","upstream_status":"200","uri":"/hostd/incentives/getfeaturedoffers.json","request_uri":"/hostd/incentives/getfeaturedoffers.json?ccode=&llp=&modelYearCode=CUT202215&trim=&zip=02738","query_params":"ccode=&llp=&modelYearCode=CUT202215&trim=&zip=02738","geoip":{"location":{"lat":"0","lon":"0"},"region_name":"","city_country_name":"","city":"","city_country_code":""}}}
```

```json hostd/autodataevdws/getvehicledetails.xml
{"nginx":{"namespace":"blue","host":"www.ramtrucks.com","proxy_protocol_addr":"","remote_addr":"23.201.194.12","proxy_add_x_forwarded_for":"2600:6c63:427f:5d1d:3155:11c8:8e36:7d0a, 96.17.145.60, 23.201.194.12","remote_user":"","time_local":"31/May/2022:14:17:18 +0000","request_method":"GET","request":"GET /hostd/autodataevdws/getvehicledetails.xml?vin=1C6RREFG3NN326052 HTTP/1.1","status":"200","body_bytes_sent":"11106","http_referer":"https://www.ramtrucks.com/new-inventory/vehicle-details.ram_1500_dt.2022.html?modelYearCode=IUT202220&vin=1C6RREFG3NN326052&dealerCode=68886&radius=100&statusCode=KZM&matchType=X&variation=cab:Crew%20Cab&attributes=drive:4x2&variation=box:5%277%22%20box&ranges=price:45485&ref=details&pageNumber=1&pageSize=10","http_user_agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/101.0.4951.67 Safari/537.36","request_length":"4275","request_time":"0.022","proxy_upstream_name":"blue-autodataevdws-40-80","upstream_addr":"10.233.84.194:8080","upstream_response_length":"11099","upstream_response_time":"0.020","upstream_status":"200","uri":"/hostd/autodataevdws/getvehicledetails.xml","request_uri":"/hostd/autodataevdws/getvehicledetails.xml?vin=1C6RREFG3NN326052","query_params":"vin=1C6RREFG3NN326052","geoip":{"location":{"lat":"0","lon":"0"},"region_name":"","city_country_name":"","city":"","city_country_code":""}}}
```

```json host/incentives/getvehicleoffers.json
{"nginx":{"namespace":"blue","host":"www.jeep.com","proxy_protocol_addr":"","remote_addr":"184.30.43.33","proxy_add_x_forwarded_for":"67.131.62.237, 165.225.62.11, 23.56.168.198, 184.30.43.33","remote_user":"","time_local":"31/May/2022:14:17:14 +0000","request_method":"GET","request":"GET /hostd/incentives/getvehicleoffers.json?zip=40601&ccode=CUJ202220WLJP75A&llp=2TE&options=APA,PRV,X7,ERC,DFT,DLK,Z1B,TKY,WHF,AL,SDA,ALC,AJW,XR1,UBN,MRU,22E&stdConfig=N HTTP/1.1","status":"200","body_bytes_sent":"6630","http_referer":"https://www.jeep.com/payment-calculator.html?isOverlay=true&calling_app=bmo&ccode=CUJ202220WLJP75A&llp=2TE&paymentType=buy&options=APA,PRV,X7,ERC,DFT,DLK,Z1B,TKY,WHF,AL,SDA,ALC,AJW,XR1,UBN,MRU,22E","http_user_agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/101.0.4951.54 Safari/537.36","request_length":"5000","request_time":"0.114","proxy_upstream_name":"blue-ws-incentives-40-80","upstream_addr":"10.233.84.187:8080","upstream_response_length":"6624","upstream_response_time":"0.116","upstream_status":"200","uri":"/hostd/incentives/getvehicleoffers.json","request_uri":"/hostd/incentives/getvehicleoffers.json?zip=40601&ccode=CUJ202220WLJP75A&llp=2TE&options=APA,PRV,X7,ERC,DFT,DLK,Z1B,TKY,WHF,AL,SDA,ALC,AJW,XR1,UBN,MRU,22E&stdConfig=N","query_params":"zip=40601&ccode=CUJ202220WLJP75A&llp=2TE&options=APA,PRV,X7,ERC,DFT,DLK,Z1B,TKY,WHF,AL,SDA,ALC,AJW,XR1,UBN,MRU,22E&stdConfig=N","geoip":{"location":{"lat":"0","lon":"0"},"region_name":"","city_country_name":"","city":"","city_country_code":""}}}
```

```json hostd/analytics/api
{"nginx":{"namespace":"analytics","host":"www.jeep.com","proxy_protocol_addr":"","remote_addr":"23.212.111.8","proxy_add_x_forwarded_for":"2603:8000:5403:d9d7:ec29:134a:397d:caf4, 23.199.233.210, 23.212.111.8","remote_user":"","time_local":"31/May/2022:14:17:20 +0000","request_method":"POST","request":"POST /hostd/analytics/api HTTP/1.1","status":"200","body_bytes_sent":"43","http_referer":"https://www.jeep.com/wrangler.html?TR=1&adid=527122644&bid=26971133&buytype=LF&channel=display&cid=142624660&dclid=CjgKEAjw-daUBhCLvIqj5t_ht1sSJABfKfUMkTnPKZW1vRDXES36uMUqOTKNWN13p_Ym1n55xgmDJfD_BwE&pid=334954472&sid=5176513","http_user_agent":"Mozilla/5.0 (Linux; Android 12; SM-S908U) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/101.0.4951.61 Mobile Safari/537.36","request_length":"4391","request_time":"0.005","proxy_upstream_name":"analytics-ackee-3000","upstream_addr":"10.233.87.133:3000","upstream_response_length":"43","upstream_response_time":"0.004","upstream_status":"200","uri":"/api","request_uri":"/hostd/analytics/api","query_params":"","geoip":{"location":{"lat":"0","lon":"0"},"region_name":"","city_country_name":"","city":"","city_country_code":""}}}
```